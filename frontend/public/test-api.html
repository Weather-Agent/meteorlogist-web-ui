<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>API Test - Weather Agent</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 3px;
        font-family: monospace;
        white-space: pre-wrap;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
      button {
        padding: 8px 16px;
        margin: 5px;
        cursor: pointer;
      }
      input {
        padding: 5px;
        margin: 5px;
        width: 300px;
      }
    </style>
  </head>
  <body>
    <h1>Weather Agent API Test</h1>

    <div class="test-section">
      <h3>Test 1: Create Session</h3>
      <button onclick="testCreateSession()">Create Session</button>
      <div id="session-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>Test 2: Send Message</h3>
      <input
        type="text"
        id="message-input"
        placeholder="Enter your weather question"
        value="get weather info of kolkata"
      />
      <button onclick="testSendMessage()">Send Message</button>
      <div id="message-result" class="result"></div>
    </div>

    <div class="test-section">
      <h3>Current Session Info</h3>
      <div id="session-info" class="result">No session created yet</div>
    </div>

    <script>
      const BASE_URL = "http://127.0.0.1:8000";
      const APP_NAME = "weatheragent";

      let currentSessionId = null;
      let currentUserId = null;

      const generateUserId = () => {
        const timestamp = Date.now().toString(36);
        const randomStr = Math.random().toString(36).substring(2, 8);
        return `user_${timestamp}_${randomStr}`;
      };

      async function testCreateSession() {
        const resultDiv = document.getElementById("session-result");
        const sessionInfoDiv = document.getElementById("session-info");

        try {
          if (!currentUserId) {
            currentUserId = generateUserId();
          }

          resultDiv.textContent = "Creating session...";
          resultDiv.className = "result";

          const response = await fetch(
            `${BASE_URL}/apps/${APP_NAME}/users/${currentUserId}/sessions`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                accept: "application/json",
              },
              body: JSON.stringify({
                state: {},
              }),
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const sessionData = await response.json();
          currentSessionId = sessionData.id;

          resultDiv.textContent = `Session created successfully!\n${JSON.stringify(
            sessionData,
            null,
            2
          )}`;
          resultDiv.className = "result success";

          sessionInfoDiv.textContent = `User ID: ${currentUserId}\nSession ID: ${currentSessionId}`;
          sessionInfoDiv.className = "result success";
        } catch (error) {
          resultDiv.textContent = `Error: ${error.message}`;
          resultDiv.className = "result error";
          console.error("Session creation error:", error);
        }
      }

      async function testSendMessage() {
        const resultDiv = document.getElementById("message-result");
        const messageInput = document.getElementById("message-input");
        const message = messageInput.value.trim();

        if (!message) {
          resultDiv.textContent = "Please enter a message";
          resultDiv.className = "result error";
          return;
        }

        if (!currentSessionId) {
          resultDiv.textContent = "Please create a session first";
          resultDiv.className = "result error";
          return;
        }

        try {
          resultDiv.textContent = "Sending message...";
          resultDiv.className = "result";

          const payload = {
            new_message: {
              role: "user",
              parts: [{ text: message }],
            },
          };

          const response = await fetch(
            `${BASE_URL}/apps/${APP_NAME}/users/${currentUserId}/sessions/${currentSessionId}`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                accept: "application/json",
              },
              body: JSON.stringify(payload),
            }
          );

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const events = await response.json();

          // Find the final response from the meteorologist
          const finalResponse = events
            .filter(
              (event) =>
                event.author === "meterologist" &&
                event.content?.parts?.[0]?.text
            )
            .pop();

          if (finalResponse) {
            resultDiv.textContent = `Success! Response from meteorologist:\n\n${
              finalResponse.content.parts[0].text
            }\n\nFull events data:\n${JSON.stringify(events, null, 2)}`;
            resultDiv.className = "result success";
          } else {
            resultDiv.textContent = `No meteorologist response found. Full events:\n${JSON.stringify(
              events,
              null,
              2
            )}`;
            resultDiv.className = "result error";
          }
        } catch (error) {
          resultDiv.textContent = `Error: ${error.message}`;
          resultDiv.className = "result error";
          console.error("Message sending error:", error);
        }
      }
    </script>
  </body>
</html>
